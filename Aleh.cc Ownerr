--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

--// Notificação ALEH.CCC (PAID)
local function CreateNotification()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Parent = game.CoreGui
    ScreenGui.Name = "AlehNotification"
    ScreenGui.ResetOnSpawn = false

    local Blur = Instance.new("BlurEffect")
    Blur.Size = 0
    Blur.Parent = Lighting

    local Sound = Instance.new("Sound")
    Sound.SoundId = "rbxassetid://127343223839315"
    Sound.Volume = 0.9
    Sound.Looped = false
    Sound.TimePosition = 3
    Sound.Parent = ScreenGui
    Sound:Play()

    local MainText = Instance.new("TextLabel")
    MainText.Parent = ScreenGui
    MainText.BackgroundTransparency = 1
    MainText.Size = UDim2.new(0, 0, 0, 0)
    MainText.Position = UDim2.new(0.5, 0, 0.45, 0)
    MainText.AnchorPoint = Vector2.new(0.5, 0.5)
    MainText.Text = "ALEH.CCC (PAID)"
    MainText.Font = Enum.Font.GothamBold
    MainText.TextColor3 = Color3.fromRGB(0, 255, 100)
    MainText.TextStrokeTransparency = 0
    MainText.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    MainText.TextSize = 70
    MainText.TextTransparency = 1

    local SubText = Instance.new("TextLabel")
    SubText.Parent = ScreenGui
    SubText.BackgroundTransparency = 1
    SubText.Size = UDim2.new(0, 0, 0, 0)
    SubText.Position = UDim2.new(0.5, 0, 0.55, 0)
    SubText.AnchorPoint = Vector2.new(0.5, 0.5)
    SubText.Text = "dc; Produzo"
    SubText.Font = Enum.Font.Gotham
    SubText.TextColor3 = Color3.fromRGB(100, 255, 150)
    SubText.TextStrokeTransparency = 0.3
    SubText.TextStrokeColor3 = Color3.fromRGB(0, 100, 0)
    SubText.TextSize = 40
    SubText.TextTransparency = 1

    local tweenInfoIn = TweenInfo.new(0.8, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
    TweenService:Create(MainText, tweenInfoIn, {Size = UDim2.new(0, 800, 0, 100), TextTransparency = 0}):Play()
    TweenService:Create(SubText, tweenInfoIn, {Size = UDim2.new(0, 500, 0, 60), TextTransparency = 0}):Play()
    TweenService:Create(Blur, tweenInfoIn, {Size = 20}):Play()

    delay(5.2, function()
        local fadeOut = TweenInfo.new(1.5, Enum.EasingStyle.Quad, Enum.EasingDirection.In)
        TweenService:Create(MainText, fadeOut, {TextTransparency = 1, Size = UDim2.new(0, 0, 0, 0)}):Play()
        TweenService:Create(SubText, fadeOut, {TextTransparency = 1, Size = UDim2.new(0, 0, 0, 0)}):Play()
        TweenService:Create(Blur, fadeOut, {Size = 0}):Play()
        Sound:Stop()
        
        delay(1.5, function()
            ScreenGui:Destroy()
            Blur:Destroy()
        end)
    end)
end

CreateNotification()
wait(9)

--// FOV Circle (centralizado)
local FOVCircle = Drawing.new("Circle")
FOVCircle.Position = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
FOVCircle.Radius = getgenv().Aleh.FOV.RadiusDrawing
FOVCircle.Color = getgenv().Aleh.FOV.Color
FOVCircle.Thickness = getgenv().Aleh.FOV.Thickness
FOVCircle.NumSides = 100
FOVCircle.Filled = getgenv().Aleh.FOV.Filled
FOVCircle.Transparency = getgenv().Aleh.FOV.Transparency
FOVCircle.Visible = getgenv().Aleh.FOV.Visible

--// Highlight
local Highlight = Instance.new("Highlight")
Highlight.FillColor = getgenv().Aleh.FOV.Color
Highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
Highlight.FillTransparency = 0.4
Highlight.OutlineTransparency = 0
Highlight.Parent = game.CoreGui

--// Cache
local CachedTarget = nil
local CachedPart = nil
local ResolvedPosition = nil

--// Funções
local function IsShiftLockActive()
    return UserInputService.MouseBehavior == Enum.MouseBehavior.LockCenter
end

local function IsPlayerDownedOrDead(player)
    local character = player.Character
    if not character then return true end

    local humanoid = character:FindFirstChildOfClass("Humanoid")
    local root = character:FindFirstChild("HumanoidRootPart")
    if not humanoid or not root then return true end

    if humanoid.Health <= 0 then return true end
    if character:FindFirstChild("Downed") or humanoid:FindFirstChild("Downed") then return true end

    local state = humanoid:GetState()
    if state == Enum.HumanoidStateType.Dead or state == Enum.HumanoidStateType.Ragdoll or state == Enum.HumanoidStateType.Physics or state == Enum.HumanoidStateType.FallingDown or state == Enum.HumanoidStateType.PlatformStanding then return true end

    if humanoid.PlatformStand then return true end

    if root.Position.Y < workspace.Terrain.MaxExtents.Min.Y + 12 or root.Position.Y < -5 then return true end

    if (character:FindFirstChild("BodyPosition") or character:FindFirstChild("BodyGyro")) and root.Velocity.Magnitude < 8 then return true end

    return false
end

local function IsVisible(part)
    if not part or not getgenv().Aleh.Silent.WallCheck then return true end
    local origin = Camera.CFrame.Position
    local direction = part.Position - origin
    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {LocalPlayer.Character}
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.IgnoreWater = true
    local result = workspace:Raycast(origin, direction, raycastParams)
    return not result or result.Instance:IsDescendantOf(part.Parent)
end

local function GetClosestToCenter()
    local center = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
    local effectiveRadius = getgenv().Aleh.Silent.FOVRadius
    if IsShiftLockActive() then effectiveRadius = effectiveRadius * getgenv().Aleh.Silent.ShiftLockFOVBoost end
    local closestDist = effectiveRadius
    local targetPlayer = nil

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Head") and not IsPlayerDownedOrDead(player) then
            local head = player.Character.Head
            local headPos, onScreen = Camera:WorldToScreenPoint(head.Position)
            if onScreen and IsVisible(head) then
                local dist = (Vector2.new(headPos.X, headPos.Y) - center).Magnitude
                if dist < closestDist then
                    closestDist = dist
                    targetPlayer = player
                end
            end
        end
    end
    return targetPlayer
end

-- CLOSE PART LEGÍTIMO E CORRIGIDO (mira exata em qualquer parte)
local function GetBestPart(character)
    if not character then return nil end

    local mousePos = Vector2.new(Mouse.X, Mouse.Y)
    local bestPart = nil
    local minDist = math.huge

    local root = character:FindFirstChild("HumanoidRootPart")
    if root and getgenv().Aleh.Silent.Resolver then
        if root.Position.Y < getgenv().Aleh.Silent.UndergroundThreshold then
            ResolvedPosition = character.Head.Position + (root.Velocity * getgenv().Aleh.Silent.Prediction)
        else
            ResolvedPosition = root.Position + (root.Velocity * getgenv().Aleh.Silent.Prediction)
        end
    else
        ResolvedPosition = nil
    end

    -- Busca em TODAS as partes possíveis
    for _, part in ipairs(character:GetChildren()) do
        if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then  -- Evita root se não quiser, mas inclui tudo
            local screenPos, onScreen = Camera:WorldToScreenPoint(part.Position)
            if onScreen and IsVisible(part) then
                local dist = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
                if dist < minDist then
                    minDist = dist
                    bestPart = part
                end
            end
        end
    end

    -- Fallback pra root ou head se nada for encontrado
    return bestPart or root or character:FindFirstChild("Head")
end

--// Loops
RunService.Heartbeat:Connect(function()
    if not getgenv().Aleh.Silent.Enabled then
        CachedTarget = nil
        CachedPart = nil
        ResolvedPosition = nil
        return
    end

    CachedTarget = GetClosestToCenter()
    if CachedTarget and CachedTarget.Character then
        CachedPart = GetBestPart(CachedTarget.Character)
    else
        CachedPart = nil
        ResolvedPosition = nil
    end
end)

RunService.RenderStepped:Connect(function()
    FOVCircle.Position = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
    FOVCircle.Visible = getgenv().Aleh.FOV.Visible and getgenv().Aleh.Silent.Enabled

    if CachedTarget and CachedTarget.Character then
        if not getgenv().Aleh.Silent.AntiAimView then
            Highlight.Adornee = CachedTarget.Character
            Highlight.Enabled = true
        else
            Highlight.Enabled = false
        end
    else
        Highlight.Enabled = false
    end
end)

--// Silent Aim Hook
local mt = getrawmetatable(game)
local oldnamecall = mt.__namecall
local oldindex = mt.__index
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
    local args = {...}
    local method = getnamecallmethod()

    if not checkcaller() and getgenv().Aleh.Silent.Enabled and CachedPart then
        if self == workspace and method == "Raycast" then
            local origin = args[1]
            if origin and (origin - Camera.CFrame.Position).Magnitude < 15 then
                local targetPos = ResolvedPosition or (CachedPart.Position + (CachedPart.Velocity * getgenv().Aleh.Silent.Prediction))
                return {
                    Position = targetPos,
                    Instance = CachedPart,
                    Material = Enum.Material.Plastic,
                    Normal = Vector3.new(0, 1, 0)
                }
            end
        end
    end

    return oldnamecall(self, ...)
end)

mt.__index = newcclosure(function(self, key)
    if not checkcaller() and getgenv().Aleh.Silent.Enabled and CachedPart and self == Mouse then
        if key == "Hit" or key == "Target" then
            local targetPos = ResolvedPosition or (CachedPart.Position + (CachedPart.Velocity * getgenv().Aleh.Silent.Prediction))
            if key == "Hit" then
                return CFrame.new(targetPos)
            else
                return CachedPart
            end
        end
    end
    return oldindex(self, key)
end)

setreadonly(mt, true)

--// Toggle
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == getgenv().Aleh.ToggleKey then
        getgenv().Aleh.Silent.Enabled = not getgenv().Aleh.Silent.Enabled
        Highlight.Enabled = false
        print("Silent Aim Da Hood (ALEH.CCC PAID):", getgenv().Aleh.Silent.Enabled and "ON" or "OFF")
    end
end)

print("ALEH.CCC (PAID) - Silent Aim Da Hood carregado com sucesso! Tecla C para toggle.")
